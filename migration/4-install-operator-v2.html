<h1 id="installing-linstor-operator-v2">Installing LINSTOR Operator v2</h1>
<p>After <a href="https://charts.linstor.io/migration/3-remove-operator-v1.html">removing the LINSTOR Operator v1 deployment</a>, you can install LINSTOR Operator v2.</p>
<p>You can deploy the LINSTOR Operator v2 by using either the <a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization">Kustomize</a> tool, integrated with <code>kubectl</code>, or else by using Helm and a LINBIT Helm chart.</p>
<p>This is the last step when migrating the LINSTOR Operator from version 1 (v1) to version 2 (v2).</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To install the LINSTOR Operator v2 into your current deployment, you will need to install the following tools:</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/"><code>kubectl</code></a></li>
<li><a href="https://docs.helm.sh/docs/intro/install/">Helm</a></li>
</ul>
<h2 id="deploying-linstor-operator-v2-by-using-kustomize">Deploying LINSTOR Operator v2 by Using Kustomize</h2>
<p>You can use <code>kubectl</code> and the built-in <code>kustomize</code> feature to deploy LINSTOR Operator v2.</p>
<p>For instructions on how to do this, refer to the documentation in the
<a href="https://linbit.com/drbd-user-guide/linstor-guide-1_0-en/#s-kubernetes-creating-operator-v2-kustomize"><em>LINSTOR User‚Äôs
Guide</em></a>. Follow the user‚Äôs guide instructions for deploying the Operator v2, After deploying the Operator, return to this page (Step 4) and continue to the ‚ÄúDeploying the LINBIT SDS Cluster‚Äù instructions below.</p>
<h2 id="deploying-linstor-operator-v2-by-using-helm">Deploying LINSTOR Operator v2 by Using Helm</h2>
<p>You can also use Helm to deploy LINSTOR Operator v2.</p>
<p>Instructions on how to do this are also in the <a href="https://linbit.com/drbd-user-guide/linstor-guide-1_0-en/#s-kubernetes-creating-operator-helm"><em>LINSTOR User‚Äôs
Guide</em></a>. Follow the user‚Äôs guide instructions for deploying the Operator v2, After deploying the Operator, return to this page (Step 4) and continue to the ‚ÄúDeploying the LINBIT SDS Cluster‚Äù instructions below.</p>
<h2 id="deploying-the-linbit-sds-cluster">Deploying the LINBIT SDS Cluster</h2>
<p>LINBIT SDS is the term that describes a LINSTOR and DRBD deployment. The LINSTOR
Operator is a part of a LINBIT SDS deployment in Kubernetes. After deploying the
LINSTOR Operator v2, you can fully deploy LINBIT SDS in your Kubernetes cluster by using the resources that you generated in <a href="https://charts.linstor.io/migration/2-collect-information.html">Step 2</a>.</p>
<h3 id="creating-a-secret">Creating a Secret</h3>
<p>When installing the LINSTOR Operator v1 by using Helm, Helm automatically generates a passphrase for LINSTOR. After Helm initializes LINSTOR with the passphrase, the LINSTOR controller will not be able to fully start without supplying the passphrase. In <a href="https://charts.linstor.io/migration/2-collect-information.html">Step 2</a> of the migration instructions, you collected the passphrase from your existing Operator v1 deployment. You will use that passphrase to create a secret that you can use to migrate your resources into the Operator v2 deployment.</p>
<p>To create the secret, enter the following commands:</p>
<pre><code># PASSPHRASE=&lt;passphrase-collected-from-kubectl-get-secrets-command-in-step-2&gt;
# cat &lt;&lt; EOF | kubectl apply -f - --server-side
apiVersion: v1
kind: Secret
metadata:
  name: linstor-op-passphrase
  namespace: linbit-sds # Change the namespace here
data:
  MASTER_PASSPHRASE: $PASSPHRASE
EOF
# unset PASSPHRASE</code></pre>
<p>Output from a successful <code>kubectl apply</code> command will show that the secret was
applied.</p>
<pre><code>secret/linstor-op-passphrase serverside-applied</code></pre>
<h3 id="applying-resources">Applying Resources</h3>
<p>Next, apply the resources that you collected in a <code>v2-resources.yaml</code> file by
running the collection script in the <a href="https://charts.linstor.io/migration/3-remove-operator-v1.html">Step
2</a> instructions.</p>
<pre><code># kubectl apply -f v2-resources.yaml --server-side</code></pre>
<blockquote>
<p>üí° <strong>TIP:</strong> In <a href="https://charts.linstor.io/migration/2-collect-information.html">Step
2</a>, you ran
the information collection script from the <code>piraeus-operator</code> directory that
you cloned locally from the upstream GitHub project. Unless you moved it, this
is the directory where you can find the script-generated <code>v2-resources.yaml</code>
file.</p>
</blockquote>
<p>Output from a successful command will show that your resources were created.</p>
<pre><code>linstorcluster.piraeus.io/linstorcluster serverside-applied
linstorsatelliteconfiguration.piraeus.io/host-networking serverside-applied
linstorsatelliteconfiguration.piraeus.io/linstor-op-ns serverside-applied</code></pre>
<p>Now the cluster will come up, using the existing data to restore the cluster state.</p>
<h2 id="verifying-cluster-state">Verifying Cluster State</h2>
<p>Before verifying your cluster state, you can change your <code>kubectl</code> command
context to the <code>linbit-sds</code> namespace, by entering the following command:</p>
<pre><code># kubectl config set-context --current --namespace=linbit-sds</code></pre>
<p>Next, you can check the cluster state by using various <code>linstor</code> command line client commands:</p>
<pre><code># kubectl exec deploy/linstor-controller -- linstor node list
# kubectl exec deploy/linstor-controller -- linstor storage-pool list
# kubectl exec deploy/linstor-controller -- linstor resource list-volumes
# kubectl exec deploy/linstor-controller -- linstor error-reports list</code></pre>
<p>You can also <a href="https://linbit.com/drbd-user-guide/linstor-guide-1_0-en/#s-kubernetes-basic-configuration-and-deployment">provision new
volumes</a>, to verify that the cluster is operational.</p>
